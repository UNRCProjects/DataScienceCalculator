#importar librer√≠as necesarias
import tensorflow as tf
from tensorflow.keras.preprocessing.image import load_img, img_to_array
from tensorflow.keras.datasets import mnist
import matplotlib.pyplot as plt
import numpy as np
from tensorflow.keras import layers, models
from tensorflow.keras.models import Sequential
from tensorflow.keras.layers import Conv2D, MaxPooling2D, Flatten, Dense

#Cargar el dataset
(x_train, y_train), (x_test, y_test) = mnist.load_data()
#Normalizar los datos (valores entre 0 y 1)
x_train = x_train.astype('float32') / 255
x_test = x_test.astype('float32') / 255

#CNN  color/escala de grises: 28x28x1
x_train = np.expand_dims(x_train, -1)
x_test = np.expand_dims(x_test, -1)

#Definir el modelo CNN
model = Sequential([
    # Primera capa convolucional
    Conv2D(32, (3, 3), activation='relu', input_shape=(28, 28, 1)),
    MaxPooling2D((2, 2)),
    # Segunda capa convolucional
    Conv2D(64, (3, 3), activation='relu'),
    MaxPooling2D((2, 2)),
    # Capas 
    Flatten(),
    Dense(100, activation='relu'),
    Dense(10, activation='softmax') 
    ])

#Compilar el modelo
model.compile(optimizer='adam',
              loss='sparse_categorical_crossentropy',
              metrics=['accuracy'])

#Entrenar el modelo
model.fit(x_train, y_train, epochs=5, validation_data=(x_test, y_test))

#Guardar el modelo entrenado 
model.save('my_model.keras.h5')


# Cargar el modelo guardado
loaded_model = load_model('mnist_cnn_model.h5')

def predecir_imagen_usuario(ruta_imagen):
    img = Image.open(ruta_imagen).convert('L') # Abrir y convertir a escala de grises
    img = img.resize((28, 28))
    img_array = np.array(img) / 255.0 # Normalizar
    img_array = np.expand_dims(img_array, axis=-1) 
    img_array = np.expand_dims(img_array, axis=0) 

    predicciones = loaded_model.predict(img_array)
    numero_predicho = np.argmax(predicciones)

    return numero_predicho